<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Calibrating GEüåétop</title>

	<meta name="description" content="Calibration of the GEOtop model using evolutionary algorithms on supercomputers">
	<meta name="author" content="Stefano Campanella">

	<link rel="stylesheet" href="reveal.js/dist/reset.css">
	<link rel="stylesheet" href="reveal.js/dist/reveal.css">
	<link rel="stylesheet" href="reveal.js/dist/theme/mhpc.css" id="theme">
	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="reveal.js/plugin/highlight/monokai.css" id="highlight-theme">
	<!-- Theme used for katex -->
	<link rel="stylesheet" <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
</head>

<body>
	<div class="reveal">

		<div class="slides">
			<section>
				<h1>GEOtop calibration using evolutionary algorithms on supercomputers</h1>
				<p>
					<small><strong>Stefano Campanella</strong></small></p>
				<p>
					<small>Giacomo Bertoldi, Alberto Sartori</small>
				</p>
				<div style="margin: 0 auto; width: 60%; display:flex; justify-content:space-between">
					<img class="plain" src="assets/mhpc.png" height="100px">
					<img class="plain" src="assets/hpctres.png" height="100px">
				</div>
				<div style="display:flex; justify-content:space-between">
					<img class="plain" src="assets/sissa.png" height="100px">
					<img class="plain" src="assets/ictp.png" height="100px">
					<img class="plain" src="assets/ogs.png" height="100px">
					<img class="plain" src="assets/eurac.png" height="100px">
				</div>
			</section>
			
			<section>
				<h3>Outline</h3>
				<ol>
					<li>
						<b>Intro &amp; Motivations</b>
						<ol>
							<li>GEOtop and its calibration</li>
							<li>Evolutionary algorithms and need for HPC</li>
						</ol>
					</li>
					<li>
						<b>Methodology &amp; Implementation</b>
						<ol>
							<li>Workflow: Jupyter, Nevergrad, GEOtoPy</li>
							<li>Parallel Computing in Python and Dask</li>
							<li>The Optimization Loop</li>
						</ol>
					</li>
					<li>
						<b>Results</b>
						<ol>
							<li>Example of Calibration</li>
							<li>Scaling Analysis and Modeling</li>
						</ol>
					</li>	
				</ol>
			</section>

			<section>
				<section>
					<h2>GEOtop Calibration</h2>
				</section>

				<section 
					data-background-image="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Water_cycle_diagram.pdf/page1-1280px-Water_cycle_diagram.pdf.jpg"
					data-background-size=contain>
				</section>

				<section 
					data-background-image="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Water_cycle_diagram.pdf/page1-1280px-Water_cycle_diagram.pdf.jpg"
					data-background-opacity=0.3
					data-background-size=contain>
					<h3>10'000 foot view of GEOtop calibration</h3>
					<p class=fragment>GEOtop: meterological forcing ‚Ü¶ soil water content</p>
					<p class=fragment>loss = ||predictions - observations|| (es. 1 - KGE)</p>
					<p class=fragment>‚Ññ of parameters ‚âà O(volume) + O(surface)</p>
				</section>
				
				<section data-background-color=white>
					<h4 style="color:black">Example: Soil Moisture Before Calibration</h4>
					<img src=assets/before.png>
				</section>
				
				<!-- <section data-background-color=white>
					<h3 style="color:black">SMC After Calibration</h3>
					<img src=assets/after.png>
				</section> -->

				<section>
					<h3>Challenges</h3>
					<p class=fragment>
						<span style="color: #FF2C2D">large</span> search space, 
						<span style="color: #FF2C2D">high</span> sensitivity to parameters
					</p>
					<p class=fragment>
						1D Workload: CPU-bounded, serial, 
						<span style="color: #FF2C2D">ETA ‚âà 1 min</span>
					</p>
				</section>
				
				<section>
					<h3>Goal of this Project</h3>
					<p>
						Develop a tool for calibration of GEOtop,
						including all the available parameters and 
						in the least possible time
					</p>
				</section>

				<!-- <section 
					data-background-image="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Water_cycle_diagram.pdf/page1-1280px-Water_cycle_diagram.pdf.jpg"
					data-background-opacity=0.3
					data-background-size=contain>
					<a href="https://imgflip.com/i/4z5dqs"><img src="https://i.imgflip.com/4z5dqs.jpg"/></a>
				</section> -->
			</section>
			
			<section>
				<section>
					<h2>Evolutionary Algorithms and Need for HPC</h2>
				</section>

				<section>
					<h3>Random Optimization Process</h3>
					<table>
						<tbody>
							<tr>
								<td>search space</td>
								<td>\(D \subseteq \mathbb{R}^n \), compact</td>
							</tr>
							<tr>
								<td>objective</td>
								<td>\(f: D \mapsto [0, +\infty)\), continuous</td>
							</tr>
							<tr>
								<td>optimization</td>
								<td>\(X_i: \Omega \mapsto D \mid 
									f\left(X_i\right) \leq f\left(X_{i-1}\right)\)</td>
							</tr>
						</tbody>
					</table>
					<div class=fragment>
						<h4>Example: Random Search</h4>
						<p>
							\[X_0 = U_0, \, X_i = 
							\begin{cases} 
								U_i &amp; \text{if } f(U_i) \leq f(X_{i-1}) \\ 
								X_{i-1} &amp; \text{otherwise} 
							\end{cases}\]
						</p>	
					</div>
				</section>
				
				<section>
					<h3>Evolutionary Algorithms</h3>
					<p>The complexity of the fitness landscape suggest the use of Evolutionary Algorithms (EA)</p>
					<p class=fragment>In EA, search space is sampled multiple times each generation, hence
						\(f\) can be evaluated in parallel 
						<span style="color:#FF2C2D" class=fragment><b> ‚Üê HPC kicks in</b></span>
					</p>
					<p class="fragment">
						Speedup with \(n\) CPU is \(\min\left(p, n \right) \)
						<span class=fragment><b style="color:#FF2C2D">, in theory</b></span>
					</p>
					<div class="fragment r-frame">
					<h4>Dealing with failures</h4>
					<p>The algorithms/implementation must use a re-sampling strategy</p>
					</div>
				</section>
			</section>

			<section>
				<section>
					<h2>Tools</h2>
				</section>

				<section>
					<h3>Code Used in this Project</h3>
					<ol>
						<li>GEOtoPy: A Python wrapper developed for this project</li>
						<li>Jupyter Ecosystem: Papermill, Scrapbook</li>
						<li>Facebook Nevergrad and SALib: CMA-ES, etc.</li>
						<li>Dask: distributed, jobqueue</li>
					</ol>
				</section>

				<section>
					<h3>Python for HPC</h3>
					<div class=fragment>
						<h4>Parallel Computing in Python</h4>
						<ul>
							<li>The GIL: a mutex on CPython interpreter execution</li>
							<li>Multithreading: may make sense if code release the GIL</li>
							<li>Multiprocessing: serialize state, and spawn new interpreters</li>
						</ul>
					</div>
					<div class=fragment>
						<h4>Dask Distributed</h4>
						<ul>
							<li>Part of the Dask library</li>
							<li>Able to scale on large systems (1/3 of Summit)</li>
							<li>Implements and extend the <code>concurrent.futures</code> interface</li>
						</ul>
					</div>
				</section>
			</section>

			<section>
				<section>
					<h2>Optimization Loop</h2>
				</section>
				<section>
					<h3>Ask &amp; Tell OOP interface</h3>
					<pre><code data-trim data-noescape class=python>
					while not optimizer.stop():
					    x = optimizer.ask()
					    y = f(x)
					    optimizer.tell(x, y)
					</code></pre>
				</section>

				<section>
					<h3>Parallel Execution using Futures</h3>
					<pre><code data-trim data-noescape class=python data-line-numbers="2-3|5-6|8-10">
					for _ in range(num_generations):
					    for i in range(popsize):
					        x[i] = optimizer.ask()
					    	
					    for i in range(popsize):
					        futures[i] = client.submit(lambda x: (x, f(x)), x[i])
					
					    to_tell = [] 
					    for future in as_completed(futures):
					        to_tell.append(future.result())
					</code></pre>
				</section>

				<section>
					<h3>Speculative execution</h3>
					<pre><code data-trim data-noescape class=python data-line-numbers="5-6|7-12">
					completed_queue = as_completed(futures)   
					to_tell = []
					for future in completed_queue:
					    x, y = future.result()
					    if isfinite(y):
					        to_tell.append(future.result())
					    if len(to_tell) + completed_queue.count() < popsize:
					        for _ in range(num_new_futures):
					            new_x = optimizer.ask()
					            new_future = client.submit(lambda x: (x, f(x)), 
					                                       new_x)
					            completed_queue.add(new_future)
					</code></pre>
				</section>
			</section>

			<section>
				<section>
					<h2>Running on the Cluster</h2>
				</section>
				<section>
					<h3>Setup &amp; Run Script</h3>
					<pre><code data-trim data-noescape class=bash data-line-numbers="18|35-37|39|41-44|47-55|57-66|67-80">
					#! /usr/bin/env bash
					#SBATCH --tasks-per-node=1
					#SBATCH --cpus-per-task=32
					#SBATCH --mem-per-cpu=400MB
					#SBATCH --hint=nomultithread
					#SBATCH --hint=compute_bound
					#SBATCH --mail-type=ALL
					#SBATCH --verbose

					SITE=$1
					PARAMETERS_PATH=$2
					ALGORITHM=$3
					POPSIZE=$4
					NUM_GENERATIONS=$5
					TIMEOUT=$6
					OUTPUT_DIR=$7

					export TMPDIR=/dev/shm
					export PYTHONPATH=$PYTHONPATH:$MHPCPROJECT_ROOT
					export DASK_CONFIG=$MHPCPROJECT_ROOT/config/dask

					INPUT="$MHPCPROJECT_ROOT/notebooks/calibration.ipynb"
					MODEL_PATH="$MHPCPROJECT_ROOT/data/$SITE/inputs"
					OBSERVATIONS_PATH="$MHPCPROJECT_ROOT/data/$SITE/observations/obs.csv"
					NUM_PROCS=4
					NUM_CPUS=$((SLURM_CPUS_PER_TASK * SLURM_NTASKS))
					NUM_WORKERS=$((NUM_PROCS * SLURM_NTASKS))
					BUDGET=$((NUM_GENERATIONS * POPSIZE))
					SCHEDULER_WAIT_RETRY_MAX=10

					mkdir -p "$OUTPUT_DIR"
					OUTPUT="$(mktemp -p "$OUTPUT_DIR" \
						"$SITE-$ALGORITHM-$BUDGET-$NUM_CPUS-XXX.ipynb")"

					mkdir -p "$MHPCPROJECT_ROOT/scheduler_files"
					SCHEDULER_FILE="$(mktemp -p "$MHPCPROJECT_ROOT/scheduler_files" \
						scheduler-XXX.json)"

					ulimit -n 128000

					dask-scheduler --scheduler-file="$SCHEDULER_FILE" \
								--no-dashboard \
								--no-show \
								--interface=ib0 &
					sleep 30

					SCHEDULER_WAIT_RETRY_COUNT=0
					while \
					! python "$MHPCPROJECT_ROOT"/scripts/check_address.py "$SCHEDULER_FILE" && \
					[[ $SCHEDULER_WAIT_RETRY_COUNT -lt $SCHEDULER_WAIT_RETRY_MAX ]]
					do
					SCHEDULER_WAIT_RETRY_COUNT=$((SCHEDULER_WAIT_RETRY_COUNT + 1))
					sleep 30
					done
					python "$MHPCPROJECT_ROOT"/scripts/check_address.py "$SCHEDULER_FILE"

					srun dask-worker --scheduler-file="$SCHEDULER_FILE" \
									--local-directory="/tmp" \
									--death-timeout=180 \
									--no-dashboard \
									--no-show \
									--nprocs=$NUM_PROCS \
									--nthreads=\
									$((SLURM_CPUS_PER_TASK / NUM_PROCS)) \
									--interface=ib0 &

					papermill --no-progress-bar \
							-p model_path "$MODEL_PATH" \
							-p timeout "$TIMEOUT" \
							-p observations_path "$OBSERVATIONS_PATH" \
							-p parameters_path "$PARAMETERS_PATH" \
							-p algorithm "$ALGORITHM" \
							-p popsize "$POPSIZE" \
							-p num_generations "$NUM_GENERATIONS" \
							-p scheduler_file "$SCHEDULER_FILE" \
							-p num_cpus $NUM_CPUS \
							-p num_workers $NUM_WORKERS \
							-p performance_report_filename \
							"${OUTPUT%.ipynb}-performance-report.html" \
							"$INPUT" "$OUTPUT"
					jupyter nbconvert --to html "$OUTPUT"
					rm "$SCHEDULER_FILE"
					</code></pre>
				</section>
			</section>

			<section>
				<section>
					<h2>Calibration example</h2>
				</section>

				<section 
					data-background-iframe="assets/DOMES-NGO-4096-256-DeW.html" 
					data-background-interactive>
				</section>
			</section>
			
			<section>
				<section>
					<h2>Scaling Analysis</h2>
				</section>

				<section style="font-size: xx-large">
					<p>\(T(p, n)\) calibration time with \(p\) individuals and \(n\) CPUs</p>
					<p class=fragment>
						\(S(p, n) := \frac{T(p, n_0)}{T(p, n)}\), 
						speedup using \(n_0 = 32\) CPUs as reference
					</p>
					<p class=fragment>
						\(S(p, n) = \frac{\min(p, n)}{n_0} \), 
						perfect speedup
					</p>
				</section>

				<section data-background-color=white>
					<h3 style="color:black">Strong Scaling</h3>
					<img src=assets/scaling_7_0.png>
				</section>

				<section data-background-color=white>
					<h3 style="color:black">Weak Scaling</h3>
					<img src=assets/scaling_12_0.png>
				</section>
			</section>

			<section>
				<section>
					<h2>Performance Modeling</h2>
				</section>
				<section>
					<h3>Linear Model</h3>
					<p>
						The simplest performance model compatible with 
						perfect weak scaling \(T(p, n) = T(\frac{p}{n})\)
						and \(T(p, n) \sim \mathcal{O}(p)\) is
						\[T(p, n) = T_0 + T_1 \frac{p}{n}\]
					</p>
				</section>

				<section data-background-color=white>
					<h3 style="color:black"> Linear Model Fit</h3>
					<img src=assets/scaling_16_0.png>
				</section>

				<section data-background-color=white>
					<h3 style="color:black"> Linear Model Speedup</h3>
					<img src=assets/scaling_18_0.png>
				</section>

				<section>
					<p> 
						Comparing the linear model speedup
						\[S(p, n) = \frac{T_0 + T_1 \frac{p}{n_0}}{T_0 + T_1 \frac{p}{n}} = 
						\frac{1}{\frac{T_0}{T_0 + T_1 \frac{p}{n_0}} + 
						\frac{T_1 \frac{p}{n_0}}{T_0 + T_1 \frac{p}{n_0}} \frac{n_0}{n}}\]
						with the Amdahl law \(S(n) = \frac{1}{(1 - f) + f \frac{n_0}{n}} \) we get
					</p>
					<p class=r-frame>
						\[f = \frac{T_1 \frac{p}{n_0}}{T_0 + T_1 \frac{p}{n_0}} \approx 97 \%\]
					</p>
				</section>

				<section>
					<h3>A Model for Large CPUs Numbers</h3>
					<p>
						\[T_\text{piecewise}(p, n) = \begin{cases} 
						T_0 + T_1 \left( \frac{p}{n} - x_0 \right) & \text{if } \frac{p}{n} \geq x_0 \\ 
						T_0 & \text{otherwise}
						\end{cases} \, ,\]
						where the effective population size is \(p_\text{eff} \approx \frac{p}{x_0} \)
					</p>
				</section>

				<section data-background-color=white>
					<h3 style="color:black"> Piecewise Linear Model Speedup</h3>
					<img src=assets/scaling_29_0.png>
				</section>
				
				<section data-background-color=white>
					<h3 style="color:black"> Large CPUs Numbers Comparison</h3>
					<img src=assets/scaling_39_0.png>
				</section>

				<section data-background-color=white>
					<h3 style="color:black"> Large CPUs Numbers Comparison</h3>
					<img src=assets/scaling_40_0.png>
				</section>
			</section>
			
			<section>
				<h3>Wrap Up</h3>
				<ul>
					<li>An automatic tool for GEOtop calibration has been developed,</li>
					<li>libraries & tools used in ML have been adapted to the purpose,</li>
					<li>it has been proven to scale up to 1024 CPUs (Ulysses V2),</li>
					<li>performance models have been proposed and discussed.</li>
				</ul>
			</section>

			<section>
				<h2>Acknowledgments</h2>
				<p>
					The research reported in this work will be supported
					by OGS, Eurac and CINECA under HPC-TRES program award number 2019-33
				</p>
				<p>
					EURAC supported this work using funding from the European Regional Development Fund, 
					Operational Programme Investment for growth and jobs ERDF 2014-2020 under Project number ERDF1094, 
					Data Platform and Sensing Technology for Environmental Sensing LAB ‚Äì DPS4ESLAB.
				</p>
			</section>
		</div>
	</div>

	<script src="reveal.js/dist/reveal.js"></script>
	<script src="reveal.js/plugin/notes/notes.js"></script>
	<script src="reveal.js/plugin/markdown/markdown.js"></script>
	<script src="reveal.js/plugin/highlight/highlight.js"></script>
	<script>
		// More info about initialization & config:
		// - https://revealjs.com/initialization/
		// - https://revealjs.com/config/
		Reveal.initialize({
			hash: true,

			// Learn about plugins: https://revealjs.com/plugins/
			plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
		});
	</script>

	<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" 
		integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" 
		crossorigin="anonymous">
	</script>
	<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" 
		integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa"
		crossorigin="anonymous"
		onload="renderMathInElement(document.body);">
	</script>
</body>

</html>
